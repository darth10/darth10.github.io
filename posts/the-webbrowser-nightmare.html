<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>darth10.github.io: The WebBrowser nightmare</title>
    <link rel="canonical" href="http://darth10.github.io/posts/the-webbrowser-nightmare">
    <link rel="icon" href="/img/logo.png">
    <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Alegreya Sans:400italic,700italic,400,700">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
          integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T"
          crossorigin="anonymous">
    <script src="https://code.jquery.com/jquery-3.4.1.slim.min.js"
            integrity="sha256-pasqAKBDmFT4eHoN2ndd6lN370kFiGUFyTiUHWhU7k8="
            crossorigin="anonymous" defer></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"
            integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM"
            crossorigin="anonymous" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/darkmode-js@1.5.5/lib/darkmode-js.min.js"
            defer></script>

    <link href="/css/screen.css" rel="stylesheet" type="text/css" />
    <link href="/css/solarized-dark.css" rel="stylesheet" type="text/css" />

    <script src="/js/turbolinks.min.js" defer></script>
    <script src="/js/highlight.pack.min.js" defer></script>
    <script src="/js/darth10.github.io.min.js" defer></script>
    <script src="https://kit.fontawesome.com/50b9794b1c.js"
            crossorigin="anonymous" samesite="Secure" defer></script>
    
</head>
<body>
    <nav class="navbar navbar-expand-md navbar-dark fixed-top bg-dark">
        <a class="navbar-brand" href="/">darth10.github.io</a>
        <button class="navbar-toggler collapsed" type="button" data-toggle="collapse"
                data-target="#navbar-main" aria-controls="navbarsExampleDefault" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div id="navbar-main" class="navbar-collapse collapse">
            <ul class="nav navbar-nav justify-content-end">
                <li class="nav-item "><a class="nav-link" href="/">Home</a></li>
                <li class="nav-item "><a class="nav-link" href="/archives">Archives</a></li>
                
                <li class="nav-item ">
                    <a class="nav-link" href="/pages/about">About</a>
                </li>
                
                <li class="nav-item"><a class="nav-link" href="/feed.xml">RSS</a></li>
            </ul>
        </div>
    </nav>


    <div class="container">
        <div class="row">
            <div id="content" class="container-fluid">
<div id="post">

    <div class="post-header">
    <h2>The WebBrowser nightmare</h2>
    <div class="post-meta">
        <div class="date">23 September 2012</div>
    </div>
</div>
<div>
    
    <p>I recently had to use the <code>WebBrowser</code> .NET component in a project. The control is essentially Internet Explorer embedded in a <code>UserControl</code> component. Although the facilities for JavaScript interoperability and DOM manipualtion are pretty great, the control fails to meet simpler needs.</p><p>To override keyboard input handing in the control, we need to set the <code>WebBrowserShortcutsEnabled</code> property to <code>false</code> and handle the <code>PreviewKeyDown</code> event.</p><p><!&ndash;more&ndash;></p><pre><code class="csharp">public class MyControl : UserControl
{
    WebBrowser &#95;webBrowser;

    // ...

    public MyControl&#40;&#41;
    {

        // ...

        &#95;webBrowser.WebBrowserShortcutsEnabled = false;
        &#95;webBrowser.PreviewKeyDown +=
            new PreviewKeyDownEventHandler&#40;OnBrowserKeyInput&#41;;
    }

    private void OnBrowserKeyInput&#40;object sender, PreviewKeyDownEventArgs e&#41;
    {
        if &#40;e.KeyCode == Keys.W &amp;&amp;
            e.Modifiers == Keys.Control&#41;
        {
            Debug.WriteLine&#40;&quot;C-w pressed&quot;&#41;;
        }
    }
}
</code></pre><p>Surprisingly, the <code>OnBrowserKeyInput</code> method is called twice; once when the key is pressed and another time when the key is released. After some googling around, I found <a href='http://social.msdn.microsoft.com/Forums/en-US/csharpgeneral/thread/f83d3d71-ea3e-4b18-a610-30a91fae060e/'>this discussion</a> on MSDN, and it turns out to be an accepted problem with the control. The workaround requires explicity maintaining state and is quite ugly.</p><pre><code class="csharp">bool &#95;skipNextKeyDown = false;

private void OnBrowserKeyInput&#40;object sender, PreviewKeyDownEventArgs e&#41;
{
    if &#40;&#95;skipNextKeyDown&#41;
    {
        &#95;skipNextKeyDown = false;
        return;
    }

    if &#40;e.KeyCode == Keys.W &amp;&amp;
        e.Modifiers == Keys.Control&#41;
    {
        Debug.WriteLine&#40;&quot;C-w pressed&quot;&#41;;
        &#95;skipNextKeyDown = true;
    }
}
</code></pre><p>And the nightmare only begins there. The control doesn't fire the event twice for some key combinations, and so the function ends up looking something like this.</p><pre><code class="csharp">bool &#95;skipNextKeyDown = false;

private void OnBrowserKeyInput&#40;object sender, PreviewKeyDownEventArgs e&#41;
{
    if &#40;e.KeyCode == Keys.W &amp;&amp;
        e.Modifiers == &#40;Keys.Control | Keys.Alt&#41;&#41;
    {
        Debug.WriteLine&#40;&quot;C-M-w pressed&quot;&#41;;
        return;
    }

    if &#40;&#95;skipNextKeyDown&#41;
    {
        &#95;skipNextKeyDown = false;
        return;
    }

    if &#40;e.KeyCode == Keys.W &amp;&amp;
        e.Modifiers == Keys.Control&#41;
    {
        Debug.WriteLine&#40;&quot;C-w pressed&quot;&#41;;
        &#95;skipNextKeyDown = true;
    }
}
</code></pre><p>The thing that bothered me most was that this was an accepted bug in the control. Even in the .NET 4.0 version. The only way to figure out which keys made the event fire twice was by trial-and-error. It's almost like Microsoft was telling me not to use my own keyboard handling for the control, which sucked. The end result is some ugly and error prone code.</p>
</div>


    <div id="prev-next">
        
        <a href="/posts/lazy-sequences-and-streams">&laquo; Lazy sequences and streams</a>
        
        
        <a class="right" href="/posts/abstract-and-parameterized-types">Abstract and parameterized types &raquo;</a>
        
    </div>

    
    <div id="disqus_thread"></div>
    <script type="text/javascript">
        var disqus_config = function () {
            this.page.url = "http://darth10.github.io/posts/the-webbrowser-nightmare";
            this.page.identifier = "The WebBrowser nightmare";
        };
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.defer = true;
            dsq.src = '//darth10.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
    

</div>
</div>
        </div><!--/.row -->
        <footer>Copyright &copy; 2020 Akhil Wali
            (<a href="https://github.com/darth10/darth10.github.io/blob/master/LICENSE.md"
                target="_blank" rel="noreferrer">GPLv2 License</a>)
            <p style="text-align: center;">Powered by
                <a href="http://cryogenweb.org" target="_blank" rel="noreferrer">Cryogen</a> and
                <a href="https://pages.github.com/" target="_blank" rel="noreferrer">GitHub Pages</a>
            </p>
        </footer>
    </div><!--/.container -->
</body>
</html>
