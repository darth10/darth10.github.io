<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>darth10.github.io: Can extension methods solve the expression problem?</title>
    <link rel="canonical" href="https://darth10.github.io/posts/can-extension-methods-solve-the-expression-problem/">
    <link rel="icon" href="/img/logo.png">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css"
          integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh"
          crossorigin="anonymous">
    <script src="https://code.jquery.com/jquery-3.4.1.slim.min.js"
            integrity="sha256-pasqAKBDmFT4eHoN2ndd6lN370kFiGUFyTiUHWhU7k8="
            crossorigin="anonymous" defer></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js"
            integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6"
            crossorigin="anonymous" defer></script>
    <script src="/js/highlight.pack.min.js" defer></script>
    <script src="/js/darth10.github.io.min.js" defer></script>
    <script src="https://kit.fontawesome.com/50b9794b1c.js"
            crossorigin="anonymous" samesite="Secure" defer></script>
    
</head>
<body>
    <nav class="navbar navbar-expand-md navbar-dark fixed-top bg-dark">
        <a class="navbar-brand" href="/">darth10.github.io</a>
        <button class="navbar-toggler collapsed" type="button" data-toggle="collapse"
                data-target="#navbar-main" aria-controls="navbarsExampleDefault" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div id="navbar-main" class="navbar-collapse collapse">
            <ul class="nav navbar-nav justify-content-end">
                <li class="nav-item "><a class="nav-link" href="/">Home</a></li>
                <li class="nav-item "><a class="nav-link" href="/archives/">Archives</a></li>
                
                <li class="nav-item ">
                    <a class="nav-link" href="/pages/about/">About</a>
                </li>
                
                <li class="nav-item"><a class="nav-link" href="/feed.xml">RSS</a></li>
            </ul>
        </div>
    </nav>


    <div class="container">
        <div class="row">
            <div id="content" class="container-fluid">
<div id="post">

    <div class="post-header">
    <h2>Can extension methods solve the expression problem?</h2>
    <div class="post-meta">
        <div class="date">14 March 2020</div>
    </div>
</div>
<div>
    
    <p>Let's explore how <a href="https://docs.microsoft.com/en-us/dotnet/csharp/programming-guide/classes-and-structs/extension-methods">extension methods</a> in C# can solve the <i>expression problem</i>. For an introduction to the expression problem, take a look at <a href="../../posts/can-partial-classes-solve-the-expression-problem/">my first post</a> in <a href="../../tags/Solving%20the%20expression%20problem">this series</a>. Extension methods are essentially used to define operations over a given type without modifying the original definition of the type.</p><p>First, we define <code>IExpr</code> as a marker interface and implement it in the <code>Const</code> and <code>Add</code> types. The implementation of <code>Const</code> and <code>Add</code> here is identical to that in the previous post.</p><pre><code class="csharp">public interface IExpr { }

public class Const : IExpr
{
    public double Value { get; }

    public Const(double value) =&gt;
        Value = value;
}

public class Add : IExpr
{
    public IExpr Left { get; }
    public IExpr Right { get; }

    public Add(IExpr left, IExpr right) =&gt;
        (Left, Right) = (left, right);
}
</code></pre><p>The <code>Eval</code> operation is now defined as an extension method over the <code>IExpr</code> type. The implementation of <code>Eval</code> here uses a <code>switch</code> expression. Note that  the class containing this extension method may or may not be in the same namespace as the <code>IExpr</code>, <code>Const</code> and <code>Add</code> types.</p><pre><code class="csharp">public static class IExprExtensions
{
    public static double Eval(this IExpr e) =&gt; e switch {
        Const c =&gt; c.Value,
        Add a =&gt; a.Left.Eval() + a.Right.Eval(),
        _ =&gt; throw new NotImplementedException()
    };
}
</code></pre><p>The <code>View</code> operation is also defined as an extension method, but in a different namespace.</p><pre><code class="csharp">public static class IExprExtensions
{
    public static string View(this IExpr e) =&gt; e switch {
        Const c =&gt; c.Value.ToString(),
        Add a =&gt; $"({a.Left.View()} + {a.Right.View()})",
        _ =&gt; throw new NotImplementedException()
    };
}
</code></pre><p>Now, let's try adding a new <code>Mult</code> type that implements the <code>IExpr</code> interface.</p><pre><code class="csharp">public class Mult : IExpr
{
    public IExpr Left { get; }
    public IExpr Right { get; }

    public Mult(IExpr left, IExpr right) =&gt;
        (Left, Right) = (left, right);
}
</code></pre><p>Again, the definition of the <code>Mult</code> type is identical to that in the previous post. However, the extension methods defined previously are not aware of this type, and so new extension methods that wrap around the previous definitions will be needed.</p><pre><code class="csharp">public static class IExprExtensions
{
    public static double Eval(this IExpr e) =&gt; e switch {
        Mult m =&gt; m.Left.Eval() * m.Right.Eval(),
        _ =&gt; Operations.Eval.IExprExtensions.Eval(e)
    };
}

public static class IExprExtensions
{
    public static string View(this IExpr e) =&gt; e switch {
        Mult m =&gt; $"({m.Left.View()} * {m.Right.View()})",
        _ =&gt; Operations.View.IExprExtensions.View(e)
    };
}
</code></pre><p>While this does satisfy the compiler, the following code will raise an exception:</p><pre><code class="csharp">var constExpr1 = new Const(7);
var constExpr2 = new Const(2);
var constExpr3 = new Const(3);

var multExpr1 = new Mult(constExpr1, constExpr2);
var multExpr2 = new Mult(constExpr2, constExpr3);

var addExpr = new Add(multExpr1, multExpr2);

addExpr.Eval();    // throws NotImplementedException 
</code></pre><p>This doesn't work as the <code>Eval</code> call above invokes the first extension method we defined, which is still unaware of the <code>Mult</code> type. We're also overlooking an important detail about <code>switch</code> expressions - they perform type casting at runtime! This violates the type safety requirement of the expression problem and unfortunately concludes that extension methods <i>cannot</i> solve the expression problem.</p><p>The code in this post can be found <a href="https://github.com/darth10/expression-problem/tree/master/csharp/Extensions">here</a> along with  <a href="https://github.com/darth10/expression-problem/tree/master/csharp/Extensions.Tests">relevant tests</a>.</p>
</div>

<div id="post-tags">
    <b>Tags: </b>
    
    <a href="/tags/Solving the expression problem/">Solving the expression problem</a>
    
</div>


    <div id="prev-next">
        
        <a href="/posts/a-lesson-from-open-source-software/">&laquo; A lesson from open source software</a>
        
        
        <a class="right" href="/posts/can-partial-classes-solve-the-expression-problem/">Can partial classes solve the expression problem? &raquo;</a>
        
    </div>

    
    <div id="disqus_thread"></div>
    <script type="text/javascript">
        var disqus_config = function () {
            this.page.url = "https://darth10.github.io/posts/can-extension-methods-solve-the-expression-problem/";
            this.page.identifier = "Can extension methods solve the expression problem?";
        };
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.defer = true;
            dsq.src = '//darth10.disqus.com/embed.js';
            dsq.setAttribute('samesite', 'Secure');
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
    

</div>
</div>
        </div><!--/.row -->
        <footer>Copyright &copy; 2021 Akhil Wali
            (<a href="https://github.com/darth10/darth10.github.io/blob/master/LICENSE.md"
                target="_blank" rel="noreferrer">GPLv2 License</a>)
            <p style="text-align: center;">Powered by
                <a href="http://cryogenweb.org" target="_blank" rel="noreferrer">Cryogen</a> and
                <a href="https://pages.github.com/" target="_blank" rel="noreferrer">GitHub Pages</a>
            </p>
        </footer>
    </div><!--/.container -->
</body>
</html>
